<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Journeyman&#x27;s Guides - Presto Data Flow</title>

      
        <link rel="alternate" type="application/atom+xml" title="RSS" href="https://jagill.github.io/zola-test/atom.xml">
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;site.css">
          <link rel="stylesheet" href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;custom.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Journeyman&#x27;s Guides</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test">Journeyman&#x27;s Guides</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://jagill.github.io/zola-test/presto-data-flow/#client" class="toc-link">Client</a>
                    
                </li>
                
                <li>
                    <a href="https://jagill.github.io/zola-test/presto-data-flow/#coordinator" class="toc-link">Coordinator</a>
                    
                </li>
                
                <li>
                    <a href="https://jagill.github.io/zola-test/presto-data-flow/#workers" class="toc-link">Workers</a>
                    
                </li>
                
                <li>
                    <a href="https://jagill.github.io/zola-test/presto-data-flow/#query-planning" class="toc-link">Query Planning</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;presto-data-flow&#x2F;">Presto Data Flow</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2018-05-05</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>Presto's speed comes from massively parallelizing queries. We've talked about
how it plans queries to be parallized, now let's talk about how it organizes
<em>execution</em> of queries: clients, coordinators, workers, and channels of
communiation between them.</p>
<span id="continue-reading"></span>
<p>When a client submits a query to Presto, it connects to a <em>coordinator</em> which
parses the query, plans the computation, and coordinates the flow of data from
the connectors to the workers and between workers.  The client can then
periodically call back to the coordinator, to retrieve status information and
any results that have been finished.</p>
<p>The coordinator acts as the brains of the operation.  It will parse the query,
plan the operations, construct the computation DAG, and requisition workers. It
will feed the input data from the connector into the upstream workers, retrieve
results from the downstream workers, and give status information and results to
the client.</p>
<p>Workers pull data from upstream workers, perform their computation, and give
data to the downstream workers.  Workers will pause working if their output
buffer is not being consumed.  Workers are grouped into <em>stages</em>; workers in
one stage pull data from workers in the upstream stage, but don't talk to other
workers in their stage.</p>
<p>This is part 5 of 5 of a series on Presto:</p>
<ol>
<li><a href="https://jagill.github.io/zola-test/presto-overview/" title="Presto Overview">Presto Overview</a></li>
<li><a href="https://jagill.github.io/zola-test/presto-connectors/" title="Presto Connectors">Presto Connectors</a></li>
<li><a href="https://jagill.github.io/zola-test/presto-map-reduce/" title="Presto Map-Reduce">Presto Map-Reduce</a></li>
<li><a href="https://jagill.github.io/zola-test/presto-joins/" title="Presto Joins">Presto Joins</a></li>
<li><a href="https://jagill.github.io/zola-test/presto-data-flow/" title="Presto Data Flow">Presto Data-Flow</a></li>
</ol>
<h2 id="client">Client<a class="zola-anchor" href="#client" aria-label="Anchor link for: client">ðŸ”—</a></h2>
<p>The client only talks to the coordinator, via HTTP POST requests.  The client
initiates the operation by submitting the query text. The response (in JSON)
contains a query handle, which the client uses in subsequent requests to check
the status or download partial results. When the client downloads results, the
coordinator will flush them from memory, freeing up buffer space for more
results.</p>
<p>In fact, if the client does not retrieve results before the coordinator's buffer
is filled, the coordinator will stop retrieving results from the final stage
workers, and all of the upstream processes will pause once their buffers are
filled. Thus it is critical that the client performs timely retrieval of the
results. The client receives results in pages (approximately 1MB each), and can
request up to 16 pages in one request.</p>
<p>If the submitted query is an <code>INSERT</code> (or other non-<code>SELECT</code>) statement, the
results are just an acknowledgement, and the operation won't block waiting for
the client.</p>
<h2 id="coordinator">Coordinator<a class="zola-anchor" href="#coordinator" aria-label="Anchor link for: coordinator">ðŸ”—</a></h2>
<p>When the coordinator receives the query text (called the <em>statement</em>) from the
client, it parses it into the <em>query</em>.  The query determines <em>stages</em> that can
be done without transferring data between workers, for example mapping
operations followed by a partial aggregation (see [Map-Reduce]). The
coordinator requisitions workers for each stage and sets up <em>exchanges</em> of data
between them.</p>
<p>The coordinator gets an estimate of how many splits of data there are from the
connector, monitors the capacity of the workers of the initial stage, and feeds
splits to any worker that has capacity.  It also monitors workers of the final
stage, grabbing completed results and storing them for the client to retrieve.</p>
<h2 id="workers">Workers<a class="zola-anchor" href="#workers" aria-label="Anchor link for: workers">ðŸ”—</a></h2>
<p>Workers act as nodes in a computation DAG.  They pull data from upstream
workers, process it, and store the results in an output buffer for downstream
workers to fetch.  If there is room in the output buffer, they repeat this
process.  If the output buffer is full (because the downstream workers aren't
pulling), the worker pauses computation until the buffer has room again.</p>
<p>Data is exchanged in <em>pages</em>, which default to 1 MB.  Workers open long-lived
HTTP POST connections with their upstreams to fetch pages.  Once a page is
pulled, the upstream worker can delete it from its output buffer.  Presto has a
configurable max page size which defaults to 16 MB; as there must be at least
one row per page, this means the max row size is equal to the max page size.</p>
<h2 id="query-planning">Query Planning<a class="zola-anchor" href="#query-planning" aria-label="Anchor link for: query-planning">ðŸ”—</a></h2>
<p>When the coordinator parses the query, it creates a tree of <em>operators</em>, like
<code>Filter</code> or <code>InnerJoin</code>.  Presto combines sequential operators that can
run on one worker into a <em>stage</em>. Between stages, data is <em>exchanged</em>; the
exchange may distribute data to any worker with capacity
(<em>round robin exchange</em>), or to a particular worker based on the hash of a key
(<em>repartitioned exchange</em>).</p>
<p>A given stage will have one or more <em>pipelines</em>, which are local sequences of
operators.  For example, a stage with only mapping and filtering operators will
have a single pipeline that combines those operators.  But a <code>JOIN</code> stage may
have three pipelines: one to read in the build table and build a hashmap, one to
read the left table, and one to stream the left table through the hashmap and
produce the output.  Between pipelines of a given stage are <em>local exchanges</em>,
which are analogous to the exchanges between stages.</p>
<p>Each stage is parallelized over multiple workers; the &quot;instance&quot; of the stage on
a worker is called a <em>task</em>.  For example, if there were <code>N</code> workers in a <code>JOIN</code>
stage, the <code>k</code>th worker would be responsible for all rows such that
<code>hash(join_key) % N == k</code>. On a given worker, each pipeline is parallelized into
<em>drivers</em>, which divide up the work for the pipeline.  A driver for a pipeline
of mapping operations might just grab any available data, but a driver that is
streaming a left table through a hashmap would futher split the hash table and
streaming rows by hashing.  Thus, the Pipeline/Process/Driver parallelization is
analogous to that of the Stage/Worker/Task.</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;tags&#x2F;presto&#x2F;">#presto</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;presto-joins&#x2F;">â€¹ Presto Joins</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;computer-memory&#x2F;">A Primer on Computer Memory â€º</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;jagill.github.io&#x2F;zola-test&#x2F;even.js" ></script>
      
    </body>

</html>
